# automation-extra-plugin [![Build Status](https://travis-ci.org/berstend/puppeteer-extra.svg?branch=master)](https://travis-ci.org/berstend/puppeteer-extra) [![npm](https://img.shields.io/npm/v/automation-extra-plugin.svg)](https://www.npmjs.com/package/automation-extra-plugin)

## Installation

```bash
yarn add automation-extra-plugin
```

## WIP

New base plugin to support both Playwright and Puppeteer.

**UNDER ACTIVE DEVELOPMENT - NOT MEANT TO BE USED YET**

## Differences

Successor to `puppeteer-extra-plugin`

- Simpler API surface
- Ships with `this.env` which gives info about the current environment and provides type guards
- New Playwright specific events (`beforeContext`, `onContextCreated`, `onContextClose`)
- Removed crusty "data from plugins" logic
- Plugins don't register their own event listeners anymore (`_bindBrowserEvents` is gone), everything is called from the mother ship (`automation-extra`)
- Supports requiring dependencies with a specific config
- Much improved type safety
- TODO: A shim and utility functions will make writing agnostic plugins easier

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

- [class: PluginLifecycleMethods](#class-pluginlifecyclemethods)
  - [.onPluginRegistered()](#onpluginregistered)
  - [.beforeLaunch(options)](#beforelaunchoptions)
  - [.afterLaunch(browser, launchContext)](#afterlaunchbrowser-launchcontext)
  - [.beforeConnect(options)](#beforeconnectoptions)
  - [.afterConnect(browser, launchContext)](#afterconnectbrowser-launchcontext)
  - [.onBrowser(browser, launchContext)](#onbrowserbrowser-launchcontext)
  - [.beforeContext(options, browser)](#beforecontextoptions-browser)
  - [.onContextCreated(context, options)](#oncontextcreatedcontext-options)
  - [.onPageCreated(page)](#onpagecreatedpage)
  - [.onPageClose(page)](#onpageclosepage)
  - [.onContextClose(context)](#oncontextclosecontext)
  - [.onDisconnected(browser)](#ondisconnectedbrowser)
- [class: AutomationExtraPlugin](#class-automationextraplugin)
  - [.env](#env)
  - [.name](#name)
  - [.defaults](#defaults)
  - [.requirements](#requirements)
  - [.dependencies](#dependencies)
  - [.opts](#opts)
  - [.debug](#debug)
- [class: LauncherEnv](#class-launcherenv)
  - [.browserName](#browsername)
  - [.driverName](#drivername)
  - [.isPuppeteerPage(obj)](#ispuppeteerpageobj)
  - [.isPuppeteerBrowser(obj)](#ispuppeteerbrowserobj)
  - [.isPuppeteerBrowserContext(obj)](#ispuppeteerbrowsercontextobj)
  - [.isPlaywrightPage(obj)](#isplaywrightpageobj)
  - [.isPlaywrightBrowser(obj)](#isplaywrightbrowserobj)
  - [.isPlaywrightBrowserContext(obj)](#isplaywrightbrowsercontextobj)

### class: [PluginLifecycleMethods](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L37-L203)

Plugin lifecycle methods

---

#### .[onPluginRegistered()](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L41-L41)

Returns: **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;void>**

After the plugin has been registered, called early in the life-cycle (once the plugin has been added).

---

#### .[beforeLaunch(options)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L59-L59)

- `options` **LaunchOptions** Puppeteer/Playwright launch options

Returns: **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;(LaunchOptions | void)>**

Before a new browser instance is created/launched.

Can be used to modify the puppeteer/playwright launch options by modifying or returning them.

Plugins using this method will be called in sequence to each
be able to update the launch options.

Example:

```javascript
async beforeLaunch (options) {
  if (this.opts.flashPluginPath) {
    options.args.push(`--ppapi-flash-path=${this.opts.flashPluginPath}`)
  }
}
```

---

#### .[afterLaunch(browser, launchContext)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L87-L87)

- `browser` **Browser** The `puppeteer` or `playwright` browser instance.
- `launchContext` **LaunchContext**

After the browser has launched.

Note: Don't assume that there will only be a single browser instance during the lifecycle of a plugin.
It's possible that `pupeeteer.launch` will be called multiple times and more than one browser created.
In order to make the plugins as stateless as possible don't store a reference to the browser instance
in the plugin but rather consider alternatives.

E.g. when using `onPageCreated` you can get a browser reference by using `page.browser()`.

Alternatively you could expose a class method that takes a browser instance as a parameter to work with:

```es6
const fancyPlugin = require('puppeteer-extra-plugin-fancy')()
puppeteer.use(fancyPlugin)
const browser = await puppeteer.launch()
await fancyPlugin.killBrowser(browser)
```

Example:

```javascript
async afterLaunch (browser, opts) {
  this.debug('browser has been launched', opts.options)
}
```

---

#### .[beforeConnect(options)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L99-L101)

- `options` **ConnectOptions** Puppeteer/playwright connect options

Returns: **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;(ConnectOptions | void)>**

Before connecting to an existing browser instance.

Can be used to modify the puppeteer/playwright connect options by modifying or returning them.

Plugins using this method will be called in sequence to each
be able to update the launch options.

---

#### .[afterConnect(browser, launchContext)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L111-L111)

- `browser` **Browser** The `puppeteer` or playwright browser instance.
- `launchContext` **LaunchContext**

After connecting to an existing browser instance.

> Note: Don't assume that there will only be a single browser instance during the lifecycle of a plugin.

---

#### .[onBrowser(browser, launchContext)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L125-L125)

- `browser` **Browser** The `puppeteer` or `playwright` browser instance.
- `launchContext` **LaunchContext**

Called when a browser instance is available.

This applies to both `launch` and `connect`.

Convenience method created for plugins that need access to a browser instance
and don't mind if it has been created through `launch` or `connect`.

> Note: Don't assume that there will only be a single browser instance during the lifecycle of a plugin.

---

#### .[beforeContext(options, browser)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L140-L143)

- `options` **Playwright.BrowserContextOptions** Playwright browser context options
- `browser` **Playwright.Browser** Playwright browser

Returns: **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)&lt;(Playwright.BrowserContextOptions | void)>**

Before a new browser context is created.

Note: Currently only triggered by `playwright`, as puppeteer's usage of context is very lackluster.

Plugins using this method will be called in sequence to each
be able to update the context options.

- **See: <https://github.com/microsoft/playwright/blob/master/docs/api.md#browsernewcontextoptions>**

---

#### .[onContextCreated(context, options)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L153-L156)

- `context` **Playwright.BrowserContext** Playwright browser context
- `options` **Playwright.BrowserContextOptions** Playwright browser context options

After a new browser context has been created.

Note: `playwright` specific.

---

#### .[onPageCreated(page)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L177-L177)

- `page` **(Puppeteer.Page | Playwright.Page)**

Called when a page has been created.

The event will also fire for popup pages.

Example:

```javascript
async onPageCreated (page) {
  let ua = await page.browser().userAgent()
  if (this.opts.stripHeadless) {
    ua = ua.replace('HeadlessChrome/', 'Chrome/')
  }
  this.debug('new ua', ua)
  await page.setUserAgent(ua)
}
```

- **See: <https://playwright.dev/#version=v1.3.0&path=docs%2Fapi.md&q=event-page>**
- **See: <https://pptr.dev/#?product=Puppeteer&version=main&show=api-event-targetcreated>**

---

#### .[onPageClose(page)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L183-L183)

- `page` **Page**

Called when a page has been closed.

---

#### .[onContextClose(context)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L191-L191)

- `context` **Playwright.BrowserContext**

Called when a browser context has been closed.

Note: `playwright` specific.

---

#### .[onDisconnected(browser)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L202-L202)

- `browser` **Browser** The `puppeteer` or `playwright` browser instance.

Called when the browser got disconnected.

This might happen because of one of the following:

- The browser is closed or crashed
- The `browser.disconnect` method was called

---

### class: [AutomationExtraPlugin](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L226-L379)

- `opts` **PluginOptions?**

**Extends: PluginLifecycleMethods**

AutomationExtraPlugin - Meant to be used as a base class and it's methods overridden.

Implements all `PluginLifecycleMethods`.

Example:

```javascript
class Plugin extends AutomationExtraPlugin {
  constructor(opts = {}) {
    super(opts)
  }

  get name() {
    return 'foobar'
  }

  async beforeLaunch(options) {
    options.headless = false
    return options
  }
}
```

---

#### .[env](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L236-L236)

Type: **[LauncherEnv](#launcherenv)**

Contains info regarding the launcher environment the plugin runs in

- **See: LauncherEnv**

---

#### .[name](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L259-L261)

Type: **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)**

Plugin name (required).

Convention:

- Package: `automation-extra-plugin-anonymize-ua`
- Name: `anonymize-ua`

Example:

```javascript
get name () { return 'anonymize-ua' }
```

---

#### .[defaults](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L284-L286)

Type: **PluginOptions**

Plugin defaults (optional).

If defined will be ([deep-](https://github.com/jonschlinkert/merge-deep))merged with the (optional) user supplied options (supplied during plugin instantiation).

The result of merging defaults with user supplied options can be accessed through `this.opts`.

Example:

```javascript
get defaults () {
  return {
    stripHeadless: true,
    makeWindows: true,
    customFn: null
  }
}

// Users can overwrite plugin defaults during instantiation:
puppeteer.use(require('puppeteer-extra-plugin-foobar')({ makeWindows: false }))
```

- **See: \[[opts]]**

---

#### .[requirements](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L309-L311)

Type: **PluginRequirements**

Plugin requirements (optional).

Signal certain plugin requirements to the base class and the user.

Currently supported:

- `launch`
  - If the plugin only supports locally created browser instances (no `puppeteer.connect()`),
    will output a warning to the user.
- `headful`
  - If the plugin doesn't work in `headless: true` mode,
    will output a warning to the user.
- `runLast`
  - In case the plugin prefers to run after the others.
    Useful when the plugin needs data from others.

Example:

```javascript
get requirements () {
  return new Set(['runLast', 'dataFromPlugins'])
}
```

---

#### .[dependencies](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L330-L332)

Type: **PluginDependencies**

Plugin dependencies (optional).

Missing plugins will be required() by automation-extra.

Example:

```javascript
// Will ensure the 'puppeteer-extra-plugin-user-preferences' plugin is loaded.
get dependencies () {
  return new Set(['user-preferences'])
}

// Will load `user-preferences` plugin and pass `{ beCool: true }` as opts
get dependencies () {
  return new Map([['user-preferences', { beCool: true }]])
}
```

---

#### .[opts](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L349-L351)

Type: **PluginOptions**

Access the plugin options (usually the `defaults` merged with user defined options)

To skip the auto-merging of defaults with user supplied opts don't define a `defaults`
property and set the `this._opts` Object in your plugin constructor directly.

Example:

```javascript
get defaults () { return { foo: "bar" } }

async onPageCreated (page) {
  this.debug(this.opts.foo) // => bar
}
```

- **See: \[[defaults]]**

---

#### .[debug](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L369-L371)

Type: **Debugger**

Convenience debug logger based on the [debug] module.
Will automatically namespace the logging output to the plugin package name.

[debug]: https://www.npmjs.com/package/debug

```bash
# toggle output using environment variables
DEBUG=automation-extra-plugin:<plugin_name> node foo.js
# to debug all the things:
DEBUG=automation-extra,automation-extra-plugin:* node foo.js
```

Example:

```javascript
this.debug('hello world')
// will output e.g. 'automation-extra-plugin:anonymize-ua hello world'
```

---

### class: [LauncherEnv](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L387-L478)

- `driverName` **(SupportedDrivers | `"unknown"`)?**

Store environment specific info and make lookups easy

---

#### .[browserName](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L394-L394)

The name of the browser engine currently in use: `"chromium" | "firefox" | "webkit"`.

---

#### .[driverName](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L399-L399)

The name of the driver currently in use: `"playwright" | "puppeteer"`.

---

#### .[isPuppeteerPage(obj)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L435-L437)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPuppeteerBrowser(obj)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L443-L445)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPuppeteerBrowserContext(obj)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L451-L453)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPlaywrightPage(obj)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L459-L461)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPlaywrightBrowser(obj)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L467-L469)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---

#### .[isPlaywrightBrowserContext(obj)](https://github.com/berstend/puppeteer-extra/blob/5d071b7ad176acc273ac4a2c5b0f176b48546047/packages/automation-extra-plugin/src/index.ts#L475-L477)

- `obj` **any** The object to test

Returns: **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)**

Type guard, will make TypeScript understand which type we're working with.

---
